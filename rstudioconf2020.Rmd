---
title: 'Taking visualizations to the next level with the scales package'
subtitle: '<img src="scaleshex.png" style="width: 100px" />' 
author: "Dana Seidel (@dpseidel) <br/><br/> https://scales.r-lib.org/"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      titleSlideClass: [center, middle, inverse]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---
class: middle, center


## What do we mean by "scales" really?? <br/> What is scaling? `r emo::ji("chart_with_upwards_trend")`

 (1) converting data values to perceptual properties 

`r emo::ji("plus")`

 (2) the inverse process: making guides (legends and axes) to read the graph 

<br/>
<br/>

Scaling and guides are often some of the most difficult parts of building any visualization.

---
class: center, middle

![](scaleshex.png)

The scales package provides the internal scaling infrastructure to
[ggplot2](https://github.com/tidyverse/ggplot2) and exports standalone, **system-agnostic**,
functions. 

The functions provided in the scales package try to make easier 5 different things about data scales:

1. labels 
2. breaks 
3. transformations
4. palettes
5. bounds & rescaling


Learning a little about these functions can help transform your plots and make you a true visualization magician `r emo::ji("wizard")`

---
class: center, middle

```{r setup, include=FALSE}
library(scales)
library(ggplot2)
library(xaringanthemer)
library(dplyr)

mono_light(
  base_color = "#1C5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Droid Mono"), 
  code_inline_color = "#DF5286", 
  link_color = "#8a0057"
)
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE, dpi = 180, fig.height = 4)
```

## `r emo::ji("warning")` Notable changes in [scales 1.1.0](https://www.tidyverse.org/blog/2019/11/scales-1-1-0/)!

+ New naming convention for guides functions: `breaks_*`, `labels_*` (enables easy tab completion!`r emo::ji("thumbs_up")`)

+ New `demo_*` functions for easy ggplot exampling
---
class: center, middle, inverse 

# Guides: Breaks & Labels

---
class: left, middle

# Label Formatters:

- `label_number`: a generic number formatter that forces intuitive decimal display of numbers
- `label_dollar`, `label_percent`, `label_comma`
- `label_scientific` 
- `label_date`, `label_time` : Formatted dates and times.
- `label_ordinal`: add ordinal suffixes (-st, -nd, -rd, -th) to numbers according to languages (e.g. English, Spanish, French).
- `label_bytes`, `label_number_si` 
- `label_parse`, `label_math`, `label_pvalue`
-` label_wrap`

For a full list and descriptions, see: [scales.r-lib.org/reference](scales.r-lib.org/reference)

---
class: center, middle

The output of all `label_*` functions is a function. All these output functions are designed to take a numeric vector (traditionally, of breaks) and return a nicely-formatted character vector.
<br/>

This makes it easy to use them directly as the input to a ggplot2 scale_* labels argument to automatically take the plots calculated breaks and label them with consistent style. 

```{r,fig.height = 1}
demo_continuous(txhousing$median, labels = label_dollar())
```

---
class: middle, center

## Changing defaults

Many of the `label_*` functions are built off of the generic `label_number` function, and allow users to easily customize label formats using consistent arguments. 

Users can specify a different rounding behavior (`accuracy`), or change the `big_mark` or `decimal_mark` for international styling; even add a `prefix` or a `suffix` or `scale` your numbers on the fly. 

```{r}
french_percent <- label_percent(decimal.mark = ",", suffix = " %", accuracy = .1)
french_percent(runif(3))

usd_to_euro <- label_dollar(prefix = "", suffix = "\u20ac", scale = .86)
usd_to_euro(100)
```

---
class: left, middle

## Breaks

- `breaks_extended()` sets most breaks by default in ggplot2 using Wilkonson's algorithm
- `breaks_pretty()` uses R's default breaks algorithm
- `breaks_log()` is used to set breaks for log transformed axes with `log_trans()`.
- `breaks_width()` is used to set breaks by width, especially useful for date and date/time axes.


Like the `label_*` functions, the output of each `breaks_*` function is a function. All these are designed to take a limits vector and return a numeric vector of break points.

---
class: center, middle, inverse 

# Transformations

---
class: center, middle

scales provides a number of common transformation functions (`*_trans()`) which specify functions to preform data transformations, format labels, and set correct breaks.

<br/>

For example: <br/>
`log_trans()`, `sqrt_trans()`, `reverse_trans()` power the `scale_*_log10()`,
`scale_*_sqrt()`, `scale_*_reverse()` functions in ggplot2. 

---
class: left, middle

## Additional Transformations
- `asn_trans()` : Arc-sin square root transformation.
- `atanh_trans()` : Arc-tangent transformation.
- `boxcox_trans()` `modulus_trans()` : Box-Cox & modulus transformations.
- `date_trans()` `time_trans()` `hms_trans()` : transformations for date, datetime, and hms classes
- `exp_trans()` : Exponential transformation (inverse of log transformation).
- `pseudolog_trans()` : Pseudo-log transformation
- `probabilty_trans()`: Probability transformation
and more... 

---
class: middle, left

## Building your own transformations

Users can also define and apply their own custom 
transformation functions for repeated use.
```{r transforms}
# use trans_new to build a new transformation
si_log <- trans_new(
  name = "si_log",
  trans = log_trans(base = 10)$trans, # extract a single element from another trans
  inverse = function(x) 10^(x), # or write your own custom functions
  breaks = breaks_log(),
  format = label_number_si()
  )
```
---
class: center, middle, inverse 

# Palettes

---
class: center, middle

# Color palettes `r emo::ji("art")`

scales provides a number of color palette functions that, given a range of values 
or the number of colors your want, will return a range of colors by hex code. 
```{r, palettes}
# pull a list of colors from any palette
viridis_pal()(4)
brewer_pal(type = "div", direction = -1)(4)
div_gradient_pal()(seq(0, 1, length.out = 4))
```

---
class: center, middle

# Hot tip `r emo::ji("fire")`

Ever wondered what colors are going to look like before you use them? 
Try `scales::show_col()`

```{r,fig.height=3}
show_col(viridis_pal()(4))
```
---
class: center, middle

## Non-color palettes
Often you want to be able to scale elements other than color. e.g. size, alpha, shape... 
Of course, scales handles those too!
```{r}
your_data <- runif(13, 1, 20)
area_pal(range = c(1, 20))(your_data)
shape_pal()(6)
```

---
class: center, middle

## See these in action in `ggplot2`...
```{r, eval=FALSE}
# color examples...
scale_fill_brewer()
scale_color_grey()
scale_color_viridis_c()
# shape examples
scale_shape()
scale_shape_ordinal()
# implement them yourself with...
scale_color_manual()
scale_shape_manual()
scale_size_manual()
# use the values as they are from your data frame with 
scale_color_identity()
scale_shape_identity()
scale_size_identity()
```

---
class: center, middle

## Or, apply them to BaseR!
Remember, while scales functions are primarily used under the hood in ggplot2, they are generic enough to be combined with any plotting system. For example, use them in combination with `grDevices::palette()`, provided with base R, to affect your base plots...

```{r, fig.height = 3}
palette(viridis_pal()(4))
plot(Sepal.Length ~ Sepal.Width, data = iris, col = Species, pch = 20)
```

---
class: center, middle, inverse

# Bounds 

---
class: center, middle

## Rescaling data
scales provides a handful of functions for rescaling data to fit new ranges.
<br/>


The rescale functions can help rescale continuous vectors to new min, mid, or max values
```{r rescale}
x <- runif(5, 0, 1)
rescale(x, to = c(0, 50))
rescale_mid(x, mid = .25)
rescale_max(x, to = c(0, 50))
```

---
class: center, middle

## Squish, Discard, Censor

- `squish` will squish your values into a specified range, respecting NAs
- `discard` will drop data outside a range, respecting NAs
- `censor`  will return NAs for values outside a range

```{r squish}
squish(c(-1, 0.5, 1, 2, NA), range = c(0, 1))
scales::discard(c(-1, 0.5, 1, 2, NA), range = c(0, 1))
censor(c(-1, 0.5, 1, 2, NA), range = c(0, 1))
```

---
class: center, middle

#### Squish can be really useful for setting the `oob` argument for a color scale with reduced limits.
```{r}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, colour = Sepal.Length)) +
  geom_point() + 
  scale_color_continuous(limit = c(6, 8), oob = scales::squish)
```


---
class: center, middle

## Example:  A quick plot
```{r, fig.height = 4}
ggplot(txhousing, aes(x = volume, y = median)) + 
  geom_point(na.rm = T)
```
---
class: left, middle

## With some scales magic... 

```{r, eval=F}
ggplot(txhousing, 
       aes(x = volume, y = median, 
           color = year, size = sales)) + 
  geom_point(na.rm = T) + 
  scale_x_continuous("Volume Sold", 
                     trans = si_log) + # our transformation
  scale_y_log10("Median House Sales Price", 
                labels = label_dollar()) +
  scale_color_viridis_c("Year") +
  scale_size_area("# Sales")
```

---
class: center, middle
```{r, fig.height = 4, echo = F}
ggplot(txhousing, 
       aes(x = volume, y = median, 
           color = year, size = sales)) + 
  geom_point(na.rm = T) + 
  scale_x_continuous("Volume Sold", 
                     trans = si_log) + # our transformation
  scale_y_log10("Median House Sales Price", 
                labels = label_dollar()) +
  scale_color_viridis_c("Year") +
  scale_size_area("# Sales")
```

---
class: center, middle

## Questions?

**Read more about scales at [scales.r-lib.org](https://scales.r-lib.org/)**

<br/>

Slides: [danaseidel.com/rstudioconf2020](https://danaseidel.com/rstudioconf2020)

Code: [github.com/dpseidel/rstudioconf2020](https://github.com/dpseidel/rstudioconf2020)

@dpseidel on [Twitter](https://twitter.com/dpseidel) and [GitHub](https://github.com/dpseidel)

<br/>

`r emo::ji("clap")` Shout out to the wonderful `xaringan`, `xaringanthemer`, & `emo` packages which helped make these slides beautiful!


And HUGE thank you to Hadley Wickham and other tidyverse developers who contributed so much to the scales 1.1.0 release! `r emo::ji("pray")`
